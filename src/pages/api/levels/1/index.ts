import { NextApiRequest, NextApiResponse } from 'next';
import { getServerSession } from 'next-auth';
import { authOptions } from '../../auth/[...nextauth]';

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  // Проверка авторизации
  const session = await getServerSession(req, res, authOptions);
  if (!session) {
    return res.status(401).json({ error: 'Необходима авторизация' });
  }

  // Только метод GET
  if (req.method !== 'GET') {
    return res.status(405).json({ error: 'Метод не разрешен' });
  }

  try {
    // Здесь будет получение данных уровня из базы данных
    // Пока используем моковые данные
    const levelData = {
      id: 1,
      title: 'Введение в продуктовое мышление',
      description: 'Первый рабочий день в компании TechInnovate',
      difficulty: 'Начальный',
      characters: {
        ceo: {
          name: 'Алексей Петров',
          role: 'CEO компании TechInnovate',
          avatar: '/images/characters/ceo.png',
          dialogs: {
            intro: [
              'Добро пожаловать в TechInnovate! Я рад, что вы присоединились к нашей команде.',
              'Мы создаем приложение TaskMaster, которое помогает людям эффективно управлять своими задачами.',
              'Наша миссия - сделать управление задачами простым и приятным.',
              'Сегодня я познакомлю вас с нашей командой, а затем мы обсудим вашу первую задачу.'
            ]
          }
        },
        designer: {
          name: 'Мария Иванова',
          role: 'Ведущий UX-дизайнер',
          avatar: '/images/characters/designer.png',
          dialogs: {
            intro: [
              'Привет! Я отвечаю за дизайн наших продуктов и пользовательский опыт.',
              'Я разрабатываю интерфейсы, проектирую пользовательские сценарии и провожу исследования с пользователями.',
              'Буду рада сотрудничать с вами над улучшением нашего продукта!'
            ]
          }
        },
        developer: {
          name: 'Дмитрий Сидоров',
          role: 'Senior разработчик',
          avatar: '/images/characters/developer.png',
          dialogs: {
            intro: [
              'Добрый день. Я руковожу разработкой нашего приложения.',
              'Моя команда занимается реализацией всех функций, исправлением багов и технической оптимизацией.',
              'Надеюсь, у нас получится продуктивное сотрудничество.'
            ]
          }
        },
        marketer: {
          name: 'Елена Кузнецова',
          role: 'Маркетолог',
          avatar: '/images/characters/marketer.png',
          dialogs: {
            intro: [
              'Привет! Я отвечаю за маркетинг и привлечение новых пользователей.',
              'Я занимаюсь продвижением продукта, анализом конкурентов и работой с обратной связью от пользователей.',
              'Буду рада поделиться маркетинговыми инсайтами для улучшения продукта.'
            ]
          }
        },
        tester: {
          name: 'Павел Николаев',
          role: 'QA инженер',
          avatar: '/images/characters/tester.png',
          dialogs: {
            intro: [
              'Здравствуйте! Я отвечаю за качество нашего продукта.',
              'Я тестирую все функции, нахожу баги и проверяю удобство использования приложения.',
              'Всегда готов помочь с анализом проблем и предоставить данные о пользовательском опыте.'
            ]
          }
        }
      },
      task: {
        title: 'Улучшение процесса создания задач',
        description: 'Пользователи жалуются на сложный процесс создания новых задач в приложении. Необходимо изучить проблему и предложить решение.',
        materials: [
          {
            type: 'user_feedback',
            title: 'Отзывы пользователей'
          },
          {
            type: 'analytics',
            title: 'Аналитика использования'
          },
          {
            type: 'interface',
            title: 'Текущий интерфейс'
          },
          {
            type: 'interviews',
            title: 'Интервью с пользователями'
          }
        ]
      },
      solutions: [
        {
          id: 'ux_focused',
          title: 'Полная переработка интерфейса',
          description: 'Разработать новый, интуитивно понятный интерфейс создания задач с фокусом на UX.',
          pros: [
            'Значительно улучшит пользовательский опыт',
            'Потенциально увеличит удержание пользователей',
            'Создаст задел для будущих улучшений'
          ],
          cons: [
            'Требует больше времени на реализацию',
            'Потребует переобучения существующих пользователей',
            'Более высокие затраты на разработку'
          ],
          suitable_for: ['ux-visionary', 'agile-coach'],
          outcome: 'Высокая удовлетворенность пользователей, но задержка в реализации других функций.'
        },
        {
          id: 'data_driven',
          title: 'Оптимизация на основе данных',
          description: 'Внести точечные изменения в критические места на основе анализа пользовательского поведения.',
          pros: [
            'Быстрая реализация',
            'Основано на реальных данных',
            'Минимальное влияние на текущих пользователей'
          ],
          cons: [
            'Может не решить все проблемы полностью',
            'Ограниченное улучшение UX',
            'Возможна необходимость дополнительных итераций'
          ],
          suitable_for: ['growth-hacker', 'tech-pm'],
          outcome: 'Быстрое улучшение метрик конверсии, умеренное повышение удовлетворенности.'
        },
        {
          id: 'balanced',
          title: 'Сбалансированный подход',
          description: 'Сочетание редизайна ключевых элементов и оптимизации текущего процесса с учетом бизнес-целей.',
          pros: [
            'Баланс между качеством и скоростью реализации',
            'Учитывает как пользовательские, так и бизнес-потребности',
            'Умеренные затраты на разработку'
          ],
          cons: [
            'Компромиссный подход может не дать максимального эффекта',
            'Требует точного определения приоритетов',
            'Сложнее координировать выполнение задачи'
          ],
          suitable_for: ['product-lead', 'tech-pm'],
          outcome: 'Сбалансированные результаты с хорошим соотношением затрат и эффекта.'
        }
      ]
    };

    return res.status(200).json(levelData);
  } catch (error) {
    console.error('Ошибка при получении данных уровня:', error);
    return res.status(500).json({ error: 'Внутренняя ошибка сервера' });
  }
} 