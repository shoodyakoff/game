# Архитектура проекта GOTOGROW

## Общая структура
Проект GOTOGROW представляет собой веб-приложение, состоящее из клиентской и серверной частей с централизованным хранилищем данных.

## Технологический стек

### Фронтенд
- **Основной фреймворк**: Next.js (на базе React)
- **Язык программирования**: TypeScript
- **Управление состоянием**: Redux Toolkit
- **Стилизация**: Tailwind CSS + CSS Modules
- **UI компоненты**: Собственная библиотека компонентов
- **Сетевые запросы**: Axios
- **Анимации**: Framer Motion
- **Тестирование**: Jest + React Testing Library
- **Маршрутизация**: Next.js Pages Router

### Бэкенд
- **Платформа**: Node.js
- **Фреймворк**: Express
- **Язык программирования**: JavaScript/TypeScript
- **API-документация**: Swagger/OpenAPI
- **Аутентификация**: JWT (jsonwebtoken)
- **Валидация**: Joi/Yup
- **Безопасность**: Helmet, CORS, Rate Limiting
- **Логирование**: Winston
- **AI-интеграция**: OpenAI API

### База данных
- **Основная БД**: MongoDB
- **ODM**: Mongoose
- **Индексация**: Для оптимизации запросов по часто используемым полям
- **Резервное копирование**: Автоматические бэкапы

### Инфраструктура
- **Хостинг фронтенда**: Vercel/Netlify
- **Хостинг бэкенда**: Heroku/Digital Ocean
- **База данных**: MongoDB Atlas
- **CI/CD**: GitHub Actions
- **Мониторинг**: Sentry для отслеживания ошибок
- **Хранение контента**: CDN для статического контента

## Архитектура приложения

### Фронтенд

#### Слои приложения
1. **Слой представления (UI)**
   - Компоненты пользовательского интерфейса
   - Страницы приложения
   - Маршрутизация

2. **Слой управления состоянием**
   - Redux store
   - Reducers и actions
   - Селекторы

3. **Слой бизнес-логики**
   - Сервисы для работы с данными
   - Утилиты и хелперы
   - Бизнес-правила

4. **Слой доступа к данным**
   - API-клиенты
   - Адаптеры данных
   - Кэширование

#### Структура директорий
```
frontend/
  ├── public/                # Статические файлы
  │   ├── images/            # Изображения
  │   │   ├── characters/    # Изображения персонажей
  │   │   │   ├── icons/     # Иконки персонажей
  │   │   │   └── full/      # Полные изображения персонажей
  │   │   └── levels/        # Изображения для уровней
  ├── src/
  │   ├── assets/            # Ресурсы приложения
  │   ├── components/        # Общие компоненты
  │   │   ├── auth/          # Компоненты авторизации
  │   │   ├── character/     # Компоненты персонажа
  │   │   ├── game/          # Игровые компоненты
  │   │   │   ├── dialog/    # Компоненты диалогов
  │   │   │   ├── summary/   # Компоненты для саммари уровней
  │   │   │   └── choices/   # Компоненты для выбора решений
  │   │   ├── map/           # Компоненты карты
  │   │   ├── ui/            # UI-компоненты
  │   │   └── layout/        # Компоненты макета
  │   ├── pages/             # Страницы приложения (в соответствии с маршрутизацией Next.js)
  │   │   ├── api/           # API-роуты Next.js
  │   │   ├── auth/          # Страницы авторизации
  │   │   │   ├── login.tsx
  │   │   │   ├── register.tsx
  │   │   │   └── forgot-password.tsx
  │   │   ├── character/     # Страницы персонажа
  │   │   │   └── create.tsx
  │   │   ├── map/           # Страница карты
  │   │   │   └── index.tsx
  │   │   ├── level/         # Страницы уровней
  │   │   │   ├── [id].tsx   # Динамическая страница уровня
  │   │   │   └── [id]/summary.tsx # Страница саммари уровня
  │   │   ├── profile/       # Страницы профиля
  │   │   │   └── index.tsx
  │   │   └── index.tsx      # Главная страница
  │   ├── store/             # Redux store
  │   │   ├── slices/        # Redux slices
  │   │   ├── actions/       # Redux actions
  │   │   └── selectors/     # Redux selectors
  │   ├── services/          # Сервисы для работы с API
  │   │   ├── api/           # API-клиенты
  │   │   ├── auth/          # Сервисы авторизации
  │   │   ├── game/          # Игровые сервисы
  │   │   └── ai/            # Сервисы для работы с OpenAI API
  │   ├── utils/             # Утилиты и хелперы
  │   │   ├── imageLoader.ts # Утилита для работы с изображениями
  │   ├── hooks/             # Кастомные React-хуки
  │   ├── types/             # TypeScript типы и интерфейсы
  │   ├── constants/         # Константы приложения
  │   │   ├── routes.ts      # Константы маршрутов
  │   │   ├── api.ts         # Константы API
  │   │   └── characters.ts  # Информация о персонажах, включая пути к изображениям
  │   ├── contexts/          # React контексты
  │   └── styles/            # Глобальные стили
  ├── .eslintrc.js           # Конфигурация ESLint
  ├── .prettierrc            # Конфигурация Prettier
  ├── tsconfig.json          # Конфигурация TypeScript
  ├── next.config.js         # Конфигурация Next.js
  ├── tailwind.config.js     # Конфигурация Tailwind CSS
  └── package.json           # Зависимости и скрипты
```

### Бэкенд

#### Слои приложения
1. **API-слой**
   - Контроллеры
   - Маршруты
   - Middleware

2. **Слой бизнес-логики**
   - Сервисы
   - Менеджеры
   - Валидаторы

3. **Слой доступа к данным**
   - Модели
   - Репозитории
   - DTO (Data Transfer Objects)

4. **AI-интеграция**
   - Интеграция с OpenAI API
   - Обработка и формирование промптов
   - Анализ ответов

#### Структура директорий
```
backend/
  ├── src/
  │   ├── api/               # API-слой
  │   │   ├── controllers/   # Контроллеры
  │   │   │   ├── authController.js
  │   │   │   ├── characterController.js
  │   │   │   ├── levelController.js
  │   │   │   └── aiController.js  # Контроллер для работы с OpenAI API
  │   │   ├── middlewares/   # Middleware
  │   │   ├── routes/        # Маршруты
  │   │   └── validators/    # Валидаторы запросов
  │   ├── config/            # Конфигурации
  │   │   ├── database.js    # Конфигурация БД
  │   │   ├── server.js      # Конфигурация сервера
  │   │   ├── auth.js        # Конфигурация авторизации
  │   │   └── openai.js      # Конфигурация OpenAI API
  │   ├── services/          # Бизнес-логика
  │   │   ├── auth/          # Сервисы авторизации
  │   │   ├── character/     # Сервисы персонажей
  │   │   ├── level/         # Сервисы уровней
  │   │   ├── user/          # Сервисы пользователей
  │   │   └── ai/            # Сервисы для работы с OpenAI API
  │   ├── models/            # Модели данных
  │   │   ├── user.js        # Модель пользователя
  │   │   ├── character.js   # Модель персонажа
  │   │   ├── level.js       # Модель уровня
  │   │   ├── item.js        # Модель предмета
  │   │   └── aiPrompt.js    # Модель для хранения промптов и контекста AI
  │   ├── utils/             # Утилиты и хелперы
  │   │   ├── logger.js      # Логирование
  │   │   ├── error.js       # Обработка ошибок
  │   │   └── security.js    # Безопасность
  │   ├── database/          # Код для работы с БД
  │   │   ├── connection.js  # Подключение к БД
  │   │   └── seeds/         # Сиды для начальных данных
  │   │       ├── levels/    # Сиды для уровней
  │   │       └── characters.js # Сиды для персонажей
  │   └── app.js             # Входная точка приложения
  ├── .eslintrc.js           # Конфигурация ESLint
  ├── .prettierrc            # Конфигурация Prettier
  ├── .env.example           # Пример .env файла
  ├── jest.config.js         # Конфигурация Jest
  └── package.json           # Зависимости и скрипты
```

## Модульная архитектура для игрового контента

### Система шаблонов уровней
1. **Базовые компоненты для повторного использования**
   - Шаблоны диалогов
   - Шаблоны экранов принятия решений
   - Шаблоны саммари
   - Шаблоны интерактивных элементов

2. **Конфигурация уровней через JSON**
   - Структура уровня определяется JSON-конфигурацией
   - Повторно используемые компоненты принимают разное содержимое
   - Минимальное количество кода для создания новых уровней

3. **Система контента**
   - Весь контент уровней хранится в формате JSON/YAML
   - Контент отделен от логики отображения
   - Возможность добавления новых уровней без изменения кода

### Управление персонажами

1. **Централизованное хранение информации о персонажах**
   - Все персонажи описаны в едином месте (constants/characters.ts)
   - Изображения хранятся в предсказуемой структуре
   - Пути к изображениям хранятся вместе с информацией о персонажах

2. **Консистентные пути к изображениям**
   - Стандартизированная схема наименования файлов
   - Сервис для получения правильных путей к изображениям
   - Кэширование изображений для быстрой загрузки

3. **Сохранение выбора персонажа**
   - Информация о выбранном персонаже сохраняется в Redux
   - При переходе между страницами информация сохраняется
   - Бэкенд сохраняет связь между пользователем и персонажем

## Интеграция с OpenAI API

### Архитектура интеграции
1. **Сервисный слой для работы с OpenAI**
   - Абстракция для вызовов API
   - Управление ключами и лимитами
   - Обработка ошибок и повторные попытки

2. **Контекстно-зависимые промпты**
   - Система шаблонов для промптов
   - Возможность передачи контекста из игры в промпт
   - Сохранение и повторное использование эффективных промптов

3. **Интерфейс для взаимодействия**
   - UI-компоненты для отображения взаимодействия с AI
   - Потоковый режим для мгновенной обратной связи
   - Возможность сохранения результатов анализа

4. **Логика работы с AI**
   - Специальные уровни с интеграцией AI
   - Анализ пользовательского ввода
   - Персонализированные рекомендации на основе решений

### Безопасность и лимиты
1. **Управление токенами и лимитами**
   - Отслеживание использования токенов
   - Лимиты использования для пользователей
   - Приоритизация запросов

2. **Фильтрация и модерация**
   - Предварительная проверка ввода пользователя
   - Фильтрация неприемлемого содержимого
   - Логирование запросов и ответов

## Маршрутизация и URL-структура

### Структура URL
1. **Основные страницы**
   - Главная: `/`
   - Авторизация: `/auth/login`, `/auth/register`, `/auth/forgot-password`
   - Создание персонажа: `/character/create`
   - Карта уровней: `/map`
   - Уровень: `/level/[id]`
   - Саммари уровня: `/level/[id]/summary`
   - Профиль: `/profile`

2. **Использование Next.js Router**
   - Серверный рендеринг для основных страниц
   - Client-side navigation для плавных переходов
   - Сохранение состояния между переходами

3. **Обработка состояний страниц**
   - Защищенные маршруты (требующие авторизации)
   - Редиректы на основе состояния пользователя
   - Постоянные URL-адреса для шеринга и закладок

## Работа со стилями

### Принципы работы со стилями
1. **Локализация стилей**
   - CSS модули для изоляции стилей компонентов
   - Tailwind для утилитарных классов
   - Глобальные стили только для общих элементов

2. **Переиспользование стилей**
   - Стилевые темы и переменные
   - Компоненты с проп-контролируемыми стилями
   - Сохранение установленных стилей при обновлении логики

3. **Разделение ответственности**
   - Логика компонентов отделена от стилизации
   - Изменения логики не должны затрагивать стили
   - Документирование стилевых решений

## Модель данных

### Основные сущности
1. **User (Пользователь)**
   - Данные аутентификации
   - Базовая информация профиля
   - Связь с персонажем

2. **Character (Персонаж)**
   - Имя и тип
   - Характеристики
   - Инвентарь
   - Прогресс
   - Пути к изображениям (иконка, полное изображение)

3. **Level (Уровень)**
   - Информация об уровне
   - Содержимое уровня (модульные компоненты)
   - Варианты прохождения
   - Награды
   - Информация об AI-интеграции (если применимо)

4. **Item (Предмет)**
   - Название и описание
   - Тип и эффекты
   - Принадлежность персонажу
   - Визуальное представление

5. **Progress (Прогресс)**
   - Статус прохождения уровней
   - История действий
   - Достижения
   - Статистика

6. **AIPrompt (Промпты для AI)**
   - Шаблоны промптов для различных ситуаций
   - Контексты использования
   - Метрики эффективности

### Связи между сущностями
- User -> Character (One-to-One)
- Character -> Items (One-to-Many)
- User -> Progress (One-to-One)
- Progress -> Levels (Many-to-Many)
- Level -> AIPrompt (Many-to-Many, опционально)

## Потоки данных

### Аутентификация
1. Пользователь вводит учетные данные
2. Фронтенд отправляет запрос на бэкенд
3. Бэкенд проверяет данные и генерирует JWT
4. Фронтенд сохраняет токен и использует его для последующих запросов

### Игровой процесс
1. Пользователь выбирает уровень на карте
2. Фронтенд запрашивает данные уровня с бэкенда
3. Пользователь взаимодействует с уровнем, принимает решения
4. Фронтенд периодически сохраняет прогресс на бэкенд
5. По завершении уровня результаты отправляются на бэкенд
6. Бэкенд обрабатывает результаты, обновляет прогресс и возвращает саммари

### Взаимодействие с OpenAI
1. Пользователь вводит текст для анализа (например, конкурентный анализ)
2. Фронтенд отправляет текст на бэкенд вместе с контекстом уровня
3. Бэкенд формирует промпт на основе шаблона и контекста
4. Запрос отправляется в OpenAI API
5. Ответ обрабатывается и возвращается пользователю
6. Результат анализа сохраняется в прогрессе пользователя

## Масштабирование и расширяемость

### Масштабирование
- Горизонтальное масштабирование бэкенда через добавление новых экземпляров
- Кэширование часто запрашиваемых данных (Redis)
- Оптимизация запросов к БД через индексы и агрегацию

### Расширяемость
- Модульная архитектура для добавления новых типов контента
- Система плагинов для расширения функциональности
- Гибкая система правил для настройки игровой механики

## Безопасность
- JWT для аутентификации
- HTTPS для шифрования трафика
- Валидация всех входных данных
- Ограничение запросов (Rate Limiting)
- Защита от CSRF, XSS, SQL-инъекций
- Хеширование паролей с использованием bcrypt

## Производительность
- Ленивая загрузка компонентов и данных
- Кэширование на клиенте и сервере
- Оптимизация бандла фронтенда
- Минификация и сжатие ресурсов
- CDN для статических файлов

## Система управления сессиями

### Компоненты для управления сессиями
1. **DashboardInitializer**
   - Компонент для проверки актуальности сессии при входе на дашборд
   - Выполняет однократную проверку при загрузке страницы
   - Использует глобальный Set для отслеживания проверенных сессий
   - Механизм предотвращения повторных запросов

2. **SessionManager**
   - Глобальный компонент для управления состоянием сессии
   - Регулярное обновление сессии на защищенных маршрутах
   - Проверяет сессию каждые 5 минут на указанных маршрутах
   - Предотвращает лишние обновления через механизм троттлинга

3. **LogoutButton**
   - Улучшенный компонент для безопасного выхода из системы
   - Очистка всех связанных с сессией данных в localStorage/sessionStorage
   - Предотвращение многократных запросов при выходе
   - Использование прямого перенаправления для предотвращения ошибок

### API для работы с сессиями
1. **/api/auth/update-session**
   - Проверка актуальности сессии
   - Кэширование результатов для снижения нагрузки на БД
   - Сравнение данных из сессии и базы данных
   - TTL кэша - 5 минут (300 000 миллисекунд)

2. **/api/auth/session-refresh**
   - Принудительное обновление данных сессии
   - Получение актуальных данных пользователя из БД
   - Поддержка отладочной информации в режиме разработки

### Механизмы защиты от проблем с сессиями
1. **Предотвращение бесконечных запросов**
   - Глобальный Set для отслеживания проверенных сессий
   - Механизм троттлинга для API-запросов
   - AbortController для отмены запросов при размонтировании компонентов

2. **Безопасное обновление сессии**
   - Обновление сессии только при несоответствии данных
   - Использование NextAuth update для сохранения целостности сессии
   - Обработка ошибок с поддержкой корректного состояния сессии

3. **Улучшенная обработка размонтирования**
   - Использование useRef для отслеживания монтирования компонентов
   - Предотвращение обновления состояния в размонтированных компонентах
   - Защита от утечек памяти с помощью AbortController 