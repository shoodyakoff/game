# Заметки по масштабированию проекта

Этот документ содержит информацию о текущих временных решениях в проекте, которые потребуют изменений при масштабировании для работы с реальными пользователями.

## Аутентификация и авторизация

### Текущая реализация
- Используется мок-API вместо реального бэкенда
- Пользовательские данные хранятся в:
  - Массиве `testUsers` в памяти приложения
  - Локальном хранилище браузера (localStorage)
- Аутентификация симулируется через генерацию и хранение фейковых JWT токенов
- Новые зарегистрированные пользователи добавляются в массив `testUsers` и существуют только до перезагрузки приложения

### Код, требующий изменений
- `src/store/slices/authSlice.ts`:
  - Функции `mockLoginApi` и `mockRegisterApi` необходимо заменить на реальные API-запросы
  - Асинхронные действия `login` и `register` должны использовать реальные конечные точки API
  - Сохранение в localStorage можно оставить для кэширования сессии, но основным источником правды должен быть сервер

## Управление профилем пользователя

### Текущая реализация
- Профиль пользователя отображается из данных localStorage
- Обновление профиля имитируется через таймауты
- Реальное обновление данных не происходит

### Код, требующий изменений
- `src/pages/profile/index.tsx`:
  - Функция `handleProfileUpdate` должна быть заменена на реальный API-запрос
  - Функция удаления аккаунта должна отправлять запрос на сервер

## Система персонажей

### Текущая реализация
- Персонажи хранятся локально в Redux и localStorage
- Выбор персонажа сохраняется через Redux slice `characterSlice.ts`
- Проверка выбранного персонажа осуществляется через `ProtectedRoute` компонент
- Для доступа к уровням требуется выбор персонажа

### Код, требующий изменений
- `src/store/slices/characterSlice.ts`:
  - Необходимо добавить реальные API-запросы для сохранения персонажа в БД
  - Реализовать синхронизацию с сервером при выборе персонажа
  - Добавить обработку ошибок при сетевых запросах

## Сохранение игрового прогресса

### Текущая реализация
- Данные о прогрессе уровней сохраняются в localStorage браузера
- Информация о выбранном персонаже хранится в Redux store и дублируется в localStorage
- В Redux store используется characterSlice с функциями для управления выбором персонажа
- Прогресс по уровням хранится в localStorage в ключах вида `level1_progress`, `level2_progress`
- Список завершенных уровней хранится в localStorage в ключе `completedLevels`
- Достижения и награды временно хранятся в компонентах и теряются при перезагрузке страницы

### Недостатки текущего подхода
- Данные привязаны к конкретному устройству и браузеру
- Отсутствие синхронизации между устройствами
- Ограниченный объем хранения в localStorage
- Отсутствие возможности аналитики и мониторинга прогресса
- Риск потери данных при очистке кэша браузера

### Требуемая реализация
- Создание серверной части с MongoDB для хранения всех пользовательских данных:
  - Таблица пользователей (Users)
  - Таблица персонажей (Characters)
  - Таблица прогресса (Progress)
  - Таблица достижений (Achievements)
  - Таблица наград (Rewards)
- API для сохранения и восстановления прогресса
- Механизм синхронизации между устройствами
- Возможность сохранения прогресса в оффлайн-режиме с последующей синхронизацией
- Сохранение истории действий пользователя для аналитики

### Примерная структура данных в MongoDB

#### Коллекция Progress:
```json
{
  "_id": "ObjectId",
  "userId": "ObjectId",
  "characterId": "ObjectId",
  "levelProgress": [
    {
      "levelId": "Number",
      "currentStage": "String",
      "completedStages": ["String"],
      "notes": ["String"],
      "testScore": "Number",
      "timeSpent": "Number",
      "lastUpdated": "Date"
    }
  ],
  "completedLevels": ["Number"],
  "createdAt": "Date",
  "updatedAt": "Date"
}
```

#### Коллекция Achievements:
```json
{
  "_id": "ObjectId",
  "userId": "ObjectId",
  "achievements": [
    {
      "id": "String",
      "title": "String",
      "description": "String",
      "icon": "String",
      "obtainedAt": "Date"
    }
  ],
  "createdAt": "Date",
  "updatedAt": "Date"
}
```

#### Коллекция Rewards:
```json
{
  "_id": "ObjectId",
  "userId": "ObjectId",
  "characterId": "ObjectId",
  "items": [
    {
      "id": "String",
      "title": "String",
      "description": "String",
      "icon": "String",
      "type": "String",
      "obtainedAt": "Date",
      "isEquipped": "Boolean"
    }
  ],
  "createdAt": "Date",
  "updatedAt": "Date"
}
```

## Техническая инфраструктура для масштабирования

### Бэкенд
1. **Сервер API**:
   - Node.js + Express/NestJS/Koa для API-сервера
   - Авторизация через JWT с правильной обработкой токенов
   - Валидация входящих данных

2. **База данных**:
   - MongoDB для хранения пользовательских данных и игрового прогресса
   - Схемы данных согласно спецификации в документации
   - Индексирование для оптимизации запросов

3. **Безопасность**:
   - Хеширование паролей (bcrypt/argon2)
   - HTTPS для всех запросов
   - Защита от CSRF, XSS и инъекций
   - Rate limiting для предотвращения брутфорс-атак

### Фронтенд
1. **Рефакторинг запросов**:
   - Замена моков на реальные HTTP-запросы
   - Добавление обработки ошибок сети
   - Обработка сценариев потери соединения

2. **Кэширование и производительность**:
   - Оптимизация кэширования данных
   - Стратегии повторных попыток для неудачных запросов
   - Оптимистичные обновления UI для лучшего UX

## План перехода

1. Создать реальный бэкенд с базой данных
2. Реализовать API-эндпойнты для авторизации и управления профилем
3. Обновить клиентский код для работы с реальным API
4. Добавить механизм сохранения и синхронизации игрового прогресса
5. Протестировать полный цикл регистрации, входа и сохранения данных
6. Реализовать стратегии обработки ошибок и восстановления
7. Настроить мониторинг и логирование для отслеживания проблем в реальном времени 