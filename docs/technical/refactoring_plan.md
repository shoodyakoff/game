# План рефакторинга игровой системы

Этот документ описывает комплексный план рефакторинга структуры приложения для создания более логичного и интуитивно понятного пользовательского пути. План предполагает переход от концепции "множества игр" к "одной игре с уровнями" и систематизацию работы с персонажами.

## 1. Изменение структуры маршрутизации

### Текущая структура
- `/auth/register`, `/auth/login` - страницы аутентификации 
- `/games` - страница выбора игр
- `/dashboard` - страница основного дашборда пользователя
- `/profile` - страница профиля пользователя

### Новая структура
- ✅ `/auth/register`, `/auth/login` - страницы аутентификации (без изменений)
- ✅ `/character` - страница выбора персонажа (новая)
- ✅ `/levels` - страница выбора уровней (заменяет `/games`)
- ✅ `/dashboard` - страница прогресса пользователя (обновлённая)
- ✅ `/profile` - страница профиля пользователя (без изменений)

## 2. Изменение верхней навигационной шапки

### Новая реализация
- ✅ Логотип/название игры (слева) - ведёт на главную
- ✅ Пункт "Играть" (центр) - ведёт на `/levels`
- ✅ Пункт "Прогресс" (центр) - ведёт на `/dashboard`
- ✅ Пункт "Профиль" (центр) - ведёт на `/profile`
- ✅ Информация о персонаже (справа) - аватар/имя, при клике открывает меню с опциями

### Детали изменений
- ✅ Кнопка "Играть" ведет на `/levels`
- ✅ Кнопка "Прогресс" ведет на `/dashboard`
- ✅ Кнопка "Профиль" ведет на `/profile`

## 3. Изменение бокового меню навигации

### Новая реализация
- ✅ Персонаж (аватар и имя)
- ✅ Пункт "Играть" - ведёт на `/levels`
- ✅ Пункт "Прогресс" - ведёт на `/dashboard`
- ✅ Пункт "Профиль" - ведёт на `/profile`
- ✅ Пункт "Настройки" - ведёт на `/settings` или открывает модальное окно

### Детали изменений
- ✅ Пункт "Играть" ведет на `/levels`
- ✅ Пункт "Прогресс" ведет на `/dashboard` 
- ✅ Пункт "Профиль" ведет на `/profile`

## 4. Создание страницы выбора персонажа

### Требования к новой странице `/character`
- ✅ Размещение минимум 3-4 персонажей на выбор с визуальным представлением
- ✅ Для каждого персонажа: изображение, имя и краткое описание
- ✅ Кнопка "Выбрать" для подтверждения выбора
- ✅ После выбора сохранять выбор в хранилище (localStorage и Redux store)
- ✅ Механизм перенаправления на страницу уровней после выбора

### Технические требования
- ✅ Компонент `CharacterSelection` для выбора персонажа
- ✅ Redux-состояние для хранения выбранного персонажа
- ⬜ API для сохранения выбора в MongoDB

## 5. Изменение страницы уровней (бывшая страница игр)

### Требования к странице `/levels`
- ✅ Переименовать компонент и файл с Games на Levels
- ✅ Обновить заголовок страницы на "Уровни игры"
- ✅ Создать интерфейс карты уровней с визуальным представлением прогресса
- ✅ Добавить логику проверки наличия выбранного персонажа:
  - ✅ Если персонаж не выбран, перенаправлять на `/character`
  - ✅ Если персонаж выбран, показывать карту уровней
- ✅ Добавить компонент для отображения текущего выбранного персонажа
- ✅ Добавить кнопку смены персонажа, ведущую на `/character`

### Технические требования
- ✅ Компонент `LevelMap` для отображения карты уровней
- ✅ Компонент `CharacterInfo` для показа текущего персонажа
- ✅ Система визуализации прогресса (завершенные/доступные/заблокированные уровни)

## 6. Обновление страницы прогресса (бывший дашборд)

### Текущий приветственный текст
"Добро пожаловать в личный кабинет! Здесь вы можете управлять своим профилем и отслеживать свой прогресс в играх."

### Новый приветственный текст
"Добро пожаловать в личный кабинет! Здесь вы можете отслеживать свой прогресс в игре, достижения и просматривать статистику."

### Текущая кнопка
"Начать игру"

### Новая кнопка
"Выбрать уровень"

### Детали изменений
- ✅ Ссылка кнопки "Выбрать уровень" ведет на `/levels`
- ✅ Полностью удалить блок "Мои игры"
- ✅ Изменить фокус страницы на отображение прогресса, достижений и социальных элементов
- ✅ Добавить информацию о текущем персонаже в секцию приветствия

## 7. Дополнительные изменения

### Навигация и маршруты
- ✅ Создать файл `/src/pages/levels/index.tsx` (преобразовать из games)
- ✅ Создать файл `/src/pages/character/index.tsx` (новая страница)
- ✅ Обновить компонент ProtectedRoute для поддержки новой структуры
- ✅ Добавить логику редиректа с `/games` на `/levels` для обратной совместимости

### Redux и хранение данных
- ✅ Добавить новый slice в Redux для управления выбором персонажа
- ✅ Обновить модель данных пользователя для хранения информации о выбранном персонаже
- ✅ Добавить действия для выбора и смены персонажа

### Техническая реализация
- ✅ Создать новые компоненты:
  - ✅ CharacterSelection - страница выбора персонажа
  - ✅ LevelMap - компонент карты уровней
  - ✅ CharacterInfo - компонент для отображения информации о персонаже
  - ✅ LevelCard - карточка отдельного уровня
- ✅ Обновить существующие компоненты:
  - ✅ Header - обновить навигацию
  - ✅ SideNavigation - обновить боковое меню
  - ✅ Dashboard - обновить содержимое и переориентировать на прогресс
- ✅ Логика маршрутизации:
  - ✅ Добавить проверку наличия выбора персонажа перед доступом к уровням
  - ✅ Настроить перенаправления для улучшения UX

## 8. Улучшение системы управления сессиями

### Реорганизация проверки сессий
- ✅ Создать компонент `DashboardInitializer` для проверки сессии при входе на дашборд
- ✅ Внедрить `DashboardInitializer` в страницу Dashboard для автоматической проверки сессии
- ✅ Использовать глобальный Set `CHECKED_SESSIONS` для предотвращения повторных проверок
- ✅ Добавить механизм отмены запросов при размонтировании через AbortController

### Улучшение API для работы с сессиями
- ✅ Создать эндпоинт `/api/auth/update-session` для проверки актуальности сессии
- ✅ Добавить кэширование результатов проверки сессии для снижения нагрузки на БД
- ✅ Создать эндпоинт `/api/auth/session-refresh` для принудительного обновления сессии
- ✅ Реализовать механизм сравнения данных сессии с данными в БД

### Безопасный выход из системы
- ✅ Обновить компонент `LogoutButton` для предотвращения проблем при выходе
- ✅ Добавить очистку всех связанных с сессией данных в localStorage/sessionStorage
- ✅ Использовать прямое перенаправление через `window.location.href` вместо router.push
- ✅ Добавить механизм защиты от множественных запросов на выход

## Результат

✅ Обновленная структура приложения с единой игрой, системой уровней и выбором персонажа создаст более цельный игровой опыт с чётким путём прогрессии. Изменения облегчат навигацию, сделают пользовательский путь более интуитивным и подготовят платформу для добавления новых уровней и механик в будущем. Улучшенная система управления сессиями обеспечит стабильную работу приложения, предотвратит проблемы с циклическими запросами и обеспечит безопасный выход из системы. 