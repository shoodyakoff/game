# Система аутентификации

## Общее описание
Система аутентификации позволяет пользователям создавать аккаунты и авторизоваться в игре, сохраняя прогресс и данные персонажей в базе данных. Система построена на JWT-токенах для обеспечения безопасности и удобства использования.

## Функциональность

### Регистрация
- Регистрация через email/пароль
- Валидация данных на стороне клиента и сервера
- Хеширование паролей с использованием bcrypt
- Сохранение данных пользователя в MongoDB
- Email для подтверждения аккаунта (опционально)

### Авторизация
- Вход по email/паролю
- Генерация JWT-токена при успешной авторизации
- Хранение токена в localStorage для сессии
- Механизм обновления токена (refresh token)
- Автоматический вход при наличии действительного токена

### Восстановление пароля
- Отправка ссылки для сброса пароля на email
- Временная ссылка с ограниченным сроком действия
- Форма ввода нового пароля

### Управление сессиями
- Автоматическая проверка актуальности сессии
- Кэширование данных для снижения нагрузки на базу данных
- Обновление сессии без перезагрузки страницы
- Механизм периодического обновления сессии на защищенных маршрутах
- Защита от проблем при размонтировании компонентов

### Выход из системы
- Безопасное завершение сессии с очисткой всех данных
- Защита от множественных нажатий кнопки выхода
- Прямое перенаправление на страницу входа
- Очистка всех связанных с сессией данных в localStorage/sessionStorage
- Удаление всех связанных с сессией cookie

## Технические требования

### База данных (MongoDB)
- Коллекция `users` со следующей структурой:
  ```json
  {
    "_id": "ObjectId",
    "email": "String",
    "password": "String (hashed)",
    "username": "String",
    "isActive": "Boolean",
    "emailVerified": "Boolean",
    "refreshToken": "String",
    "createdAt": "Date",
    "updatedAt": "Date"
  }
  ```

### API Endpoints

#### POST /api/auth/register
- Регистрация нового пользователя
- Принимает: `email`, `password`, `username`
- Проверяет уникальность email
- Хеширует пароль
- Возвращает JWT-токен и базовую информацию о пользователе

#### POST /api/auth/login
- Авторизация пользователя
- Принимает: `email`, `password`
- Проверяет корректность пароля
- Возвращает JWT-токен и информацию о пользователе

#### POST /api/auth/refresh-token
- Обновление JWT-токена
- Принимает: `refreshToken`
- Возвращает новый JWT-токен

#### POST /api/auth/reset-password-request
- Запрос на сброс пароля
- Принимает: `email`
- Отправляет email с ссылкой для сброса пароля

#### POST /api/auth/reset-password
- Сброс пароля
- Принимает: `token`, `newPassword`
- Проверяет валидность токена
- Обновляет пароль в базе данных

#### GET /api/auth/me
- Получение информации о текущем пользователе
- Требует JWT-аутентификацию
- Возвращает информацию о пользователе

#### POST /api/auth/update-session
- Проверка актуальности данных пользователя в сессии
- Требует JWT-аутентификацию
- Кэширует результаты для снижения нагрузки на БД
- Возвращает актуальные данные пользователя при необходимости обновления сессии

#### POST /api/auth/session-refresh
- Принудительное обновление сессии пользователя
- Требует JWT-аутентификацию
- Возвращает актуальные данные пользователя из базы данных
- Поддерживает отладочную информацию в режиме разработки

### Безопасность
- Валидация данных на стороне сервера
- Хеширование паролей с солью
- Защита от брутфорса (rate limiting)
- CORS настройки для API
- Использование HTTPS для всех запросов

## Интерфейс пользователя

### Экран регистрации
- Поля для ввода: email, пароль, подтверждение пароля
- Валидация данных в режиме реального времени
- Индикатор сложности пароля
- Кнопка отправки формы
- Ссылка на экран входа

### Экран входа
- Поля для ввода: email, пароль
- Кнопка "Запомнить меня"
- Ссылка на восстановление пароля
- Кнопка отправки формы
- Ссылка на экран регистрации

### Экран восстановления пароля
- Поле для ввода email
- Кнопка отправки формы
- Страница ввода нового пароля (доступна по ссылке из email)

## Интеграция с другими системами

### Интеграция с системой персонажей
- После регистрации пользователь направляется на создание персонажа
- При входе проверяется наличие созданного персонажа
- Если персонаж создан, пользователь направляется на карту уровней

### Интеграция с профилем
- Данные авторизации связаны с профилем пользователя
- Возможность редактирования данных профиля через защищенные API-эндпоинты

### Интеграция с прогрессом
- Система авторизации обеспечивает доступ к сохраненному прогрессу пользователя
- Все данные о прогрессе привязаны к аккаунту пользователя через userId 