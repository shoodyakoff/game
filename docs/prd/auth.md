# Система аутентификации

## Общее описание
Система аутентификации построена на NextAuth.js и позволяет пользователям создавать аккаунты и авторизоваться в игре, сохраняя прогресс и данные персонажей в базе данных. Система использует безопасные сессии на основе JWT-токенов, управляемых NextAuth.

## Функциональность

### Регистрация
- Регистрация через email/пароль с использованием NextAuth Credentials Provider
- Валидация данных на стороне клиента и сервера
- Хеширование паролей с использованием bcrypt
- Сохранение данных пользователя в MongoDB через MongoDB Adapter
- Автоматическая авторизация после успешной регистрации

### Авторизация
- Вход по email/паролю через NextAuth
- Управление сессиями через NextAuth JWT
- Безопасное хранение сессии в httpOnly cookies
- Автоматическое обновление сессии
- Защищенные маршруты с помощью NextAuth Middleware

### Восстановление пароля
- Отправка ссылки для сброса пароля на email
- Временная ссылка с ограниченным сроком действия
- Форма ввода нового пароля
- Интеграция с NextAuth для обновления сессии

### Управление сессиями
- Автоматическая проверка и обновление сессии через NextAuth
- Безопасное хранение данных сессии в зашифрованных cookies
- Обновление сессии без перезагрузки страницы
- Встроенная защита от CSRF-атак
- Поддержка параллельных вкладок браузера

### Выход из системы
- Безопасное завершение сессии через NextAuth
- Автоматическая очистка всех связанных с сессией данных
- Корректное удаление cookies
- Прямое перенаправление на страницу входа

## Технические требования

### База данных (MongoDB)
- Интеграция через MongoDB Adapter для NextAuth
- Коллекция `users` со следующей структурой:
  ```json
  {
    "_id": "ObjectId",
    "email": "String",
    "password": "String (hashed)",
    "username": "String",
    "hasCharacter": "Boolean",
    "characterType": "String",
    "avatar": "String",
    "role": "String",
    "createdAt": "Date",
    "updatedAt": "Date",
    "last_login": "Date"
  }
  ```

### API Endpoints

#### GET/POST /api/auth/[...nextauth]
- Основной endpoint NextAuth для всех операций аутентификации
- Поддерживает:
  - Регистрацию
  - Вход
  - Выход
  - Проверку сессии
  - Обновление сессии

### Безопасность
- Встроенная защита NextAuth от основных типов атак
- Валидация данных на стороне сервера
- Хеширование паролей с bcrypt
- CSRF-токены для защиты форм
- Безопасные httpOnly cookies для хранения сессии
- Автоматическое обновление JWT-токенов
- CORS настройки для API

## Интерфейс пользователя

### Экран регистрации (/auth/register)
- Поля для ввода: email, username, пароль, подтверждение пароля
- Валидация данных в режиме реального времени
- Индикация процесса регистрации
- Обработка ошибок с понятными сообщениями
- Автоматический переход в систему после регистрации

### Экран входа (/auth/login)
- Поля для ввода: email, пароль
- Интеграция с NextAuth для процесса входа
- Поддержка redirect URL для возврата на предыдущую страницу
- Обработка ошибок аутентификации

## Интеграция с другими системами

### Интеграция с системой персонажей
- Проверка наличия персонажа через hasCharacter флаг в сессии
- Автоматическое перенаправление на создание персонажа при необходимости
- Сохранение типа персонажа в данных пользователя

### Интеграция с профилем
- Доступ к данным профиля через сессию NextAuth
- Обновление аватара и других данных профиля
- Синхронизация данных между сессией и базой данных

### Интеграция с прогрессом
- Доступ к прогрессу через id пользователя из сессии
- Защита доступа к данным прогресса через NextAuth Middleware
- Автоматическая синхронизация прогресса между вкладками 