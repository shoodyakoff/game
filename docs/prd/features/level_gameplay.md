# Прохождение уровней и саммари

## Описание
Механика прохождения игровых уровней с системой диалогов, принятия решений и получения саммари с результатами по завершению каждого уровня, с полной интеграцией с базой данных и API для сохранения прогресса.

## Пользовательский сценарий
1. Пользователь выбирает уровень на карте и нажимает "Начать уровень"
2. Система запрашивает данные уровня с сервера
3. Загружается экран уровня с вводной информацией о сценарии
4. Пользователь проходит через серию диалогов и принимает решения
5. Принятые решения и промежуточный прогресс отправляются на сервер
6. В зависимости от принятых решений и характеристик персонажа формируется результат
7. По завершении уровня отображается саммари с результатами, приобретенными навыками и наградами
8. Результаты прохождения уровня сохраняются в базе данных
9. Пользователь нажимает "Вернуться на карту" и перенаправляется на карту уровней с обновленным прогрессом

## Структура уровня

### 1. Вводная часть
- Заголовок уровня
- Описание сценария и целей
- Контекстная информация для принятия решений
- Начальные условия и доступные ресурсы
- Кнопка "Начать" для перехода к основной части

### 2. Основная часть
- Серия диалогов с NPC (нарративное представление сценариев)
- Точки принятия решений с несколькими вариантами выбора
- Информационные блоки с подсказками (в зависимости от характеристик персонажа)
- Интерактивные элементы (использование предметов, анализ данных и т.д.)
- Индикатор прогресса по уровню

### 3. Завершающая часть
- Результат принятых решений
- Итоговая оценка прохождения уровня
- Анализ сильных и слабых сторон решений
- Профессиональные советы
- Полученные награды и опыт
- Кнопка "Вернуться на карту"

## Типы контента в уровнях

### 1. Диалоги
- Текстовые диалоги с персонажами
- Выбор реплик с разными эффектами
- Раскрытие персонажей и сюжета
- Влияние на отношения с NPC

### 2. Принятие решений
- Выбор из нескольких вариантов стратегических решений
- Влияние решений на результат уровня
- Различные последствия для разных типов персонажей
- Возможность использования предметов для улучшения решений

### 3. Интерактивные задания
- Анализ метрик и данных
- Приоритизация задач
- Распределение ресурсов
- Работа с пользовательскими историями
- Создание MVP и роадмапов

### 4. Саммари
- Визуальное представление результатов
- Анализ принятых решений
- Оценка по различным критериям (качество, скорость, эффективность)
- Альтернативные пути и их потенциальные результаты
- Советы по улучшению навыков

## Технические требования

### Фронтенд
1. Страница прохождения уровня (`/level/:id`)
   - Динамическое отображение контента уровня
   - Система диалогов с анимациями
   - Интерфейс для принятия решений
   - Индикаторы прогресса и статуса
   - Индикаторы синхронизации с сервером
   - Адаптивный дизайн для разных устройств
   - Анимации переходов между этапами
   - Обработка ошибок соединения с сервером

2. Страница саммари (`/level/:id/summary`)
   - Графическое представление результатов
   - Детализация принятых решений и их последствий
   - Отображение полученных наград и опыта
   - Кнопка "Вернуться на карту"
   - Возможность поделиться результатами
   - Сравнение с оптимальными решениями

3. Компоненты:
   - Компонент диалога с выбором реплик
   - Компонент принятия решений
   - Компонент интерактивных заданий
   - Компонент саммари с визуализацией результатов
   - Компонент отображения наград и опыта
   - Компонент синхронизации с сервером
   - Компонент обработки ошибок соединения

### Бэкенд
1. API для получения содержания уровня
   - Метод: GET
   - Endpoint: `/api/levels/:id/content`
   - Требует авторизации (JWT токен)
   - Проверка доступа пользователя к уровню
   - Возвращает структурированное содержание уровня, включая диалоги и варианты решений
   - Учитывает особенности персонажа пользователя

2. API для обновления прогресса
   - Метод: POST
   - Endpoint: `/api/levels/:id/progress`
   - Требует авторизации (JWT токен)
   - Проверка доступа пользователя к уровню
   - Входные данные:
     - user_id (из токена авторизации)
     - progress_data (данные о текущем прогрессе)
     - decisions (принятые решения)
   - Сохранение в базе данных
   - Возвращает статус сохранения и обновленные данные

3. API для завершения уровня
   - Метод: POST
   - Endpoint: `/api/levels/:id/complete`
   - Требует авторизации (JWT токен)
   - Проверка доступа пользователя к уровню
   - Входные данные:
     - user_id (из токена авторизации)
     - completion_data (данные о завершении)
     - decisions (все принятые решения)
     - time_spent (время, затраченное на прохождение)
     - attempts (количество попыток)
   - Валидация входных данных
   - Сохранение в базе данных
   - Расчет наград и опыта на сервере
   - Разблокировка следующих уровней
   - Возвращает результаты и саммари

4. API для получения оптимальных решений (после завершения)
   - Метод: GET
   - Endpoint: `/api/levels/:id/optimal-solutions`
   - Требует авторизации (JWT токен)
   - Проверка, что пользователь завершил уровень
   - Возвращает оптимальные решения для сравнения

### База данных
1. Обновления в коллекции `levels`:
   - Структура контента уровня:
     - `dialogues`: Array (диалоги и их варианты)
     - `decisions`: Array (точки принятия решений)
     - `interactive_tasks`: Array (интерактивные задания)
     - `results`: Object (возможные результаты уровня)
     - `optimal_solutions`: Object (оптимальные решения)
     - `prerequisites`: Array (предварительные условия для уровня)
     - `next_levels`: Array (уровни, которые разблокируются)
     - `version`: Number (версия контента уровня)
     - `created_at`: Date
     - `updated_at`: Date
     - `is_active`: Boolean

2. Обновления в коллекции `user_progress`:
   - Новые поля:
     - `decisions_made`: Array (принятые решения)
     - `results`: Object (персональные результаты прохождения)
     - `summary`: Object (саммари уровня)
     - `rewards_received`: Object (полученные награды)
     - `time_spent`: Number (время прохождения в секундах)
     - `attempts`: Number (количество попыток)
     - `completion_percentage`: Number (процент завершения)
     - `optimal_match_percentage`: Number (соответствие оптимальным решениям)
     - `last_activity`: Date
     - `version`: Number (версия прохождения)

3. Индексы:
   - `user_progress`: 
     - `user_id`: 1, `level_id`: 1 (для быстрого поиска)
     - `completion_date`: -1 (для сортировки по дате)
   - `levels`:
     - `prerequisites`: 1 (для быстрого определения доступности)
     - `is_active`: 1 (для фильтрации активных уровней)

### Кэширование:
1. Кэширование контента уровней на сервере
2. Кэширование статических элементов диалогов
3. Инвалидация кэша при обновлении контента уровня
4. Стратегия кэширования для работы в оффлайн режиме

## Интеграционные требования
1. Прогресс пользователя должен автоматически сохраняться в процессе прохождения уровня с передачей на сервер
2. Характеристики персонажа пользователя должны влиять на варианты решений и их эффективность
3. Предметы персонажа должны быть доступны для использования в соответствующих ситуациях
4. Результаты прохождения уровня должны влиять на доступность следующих уровней
5. Саммари должно генерироваться с учетом всех принятых решений и характеристик персонажа
6. Система должна корректно обрабатывать потерю соединения с сервером
7. Данные должны синхронизироваться после восстановления соединения
8. Все взаимодействия с сервером должны быть защищены аутентификацией

## Алгоритм оценки и саммари
1. Сбор данных о всех принятых решениях
2. Отправка данных на сервер для анализа
3. Сравнение с оптимальными решениями для различных типов PM
4. Учет характеристик персонажа пользователя
5. Серверный расчет эффективности решений по различным критериям
6. Формирование персонализированного саммари с рекомендациями
7. Определение полученных наград и опыта
8. Сохранение результатов в базе данных
9. Передача результатов клиенту для отображения

## Безопасность
1. Проверка JWT токена для всех API-запросов
2. Валидация всех входных данных
3. Проверка прав доступа пользователя к уровню
4. Защита от подмены результатов прохождения
5. Защита от XSS и инъекций в контенте уровня
6. Ограничение частоты запросов (rate limiting)

## Критерии готовности
1. Пользователь может успешно загрузить и пройти любой доступный уровень
2. Все диалоги и выборы корректно отображаются и функционируют
3. Решения пользователя влияют на ход уровня и его результаты
4. Саммари корректно формируется на основе принятых решений
5. Прогресс пользователя сохраняется и синхронизируется с сервером
6. Уровень завершается корректно с переходом на карту уровней
7. Все полученные награды отображаются и добавляются к профилю пользователя
8. Система корректно обрабатывает потерю соединения
9. Производительность остается стабильной на всех этапах прохождения
10. Безопасность данных обеспечивается на всех этапах взаимодействия 