# Система авторизации и аутентификации

## Общее описание
Система авторизации и аутентификации обеспечивает безопасный доступ пользователей к игровой платформе. Она включает функционал регистрации, входа, восстановления пароля и управления сессиями пользователей.

## Функциональность

### Регистрация
- Создание нового аккаунта с использованием email и пароля
- Валидация email и проверка на уникальность
- Требования к надежности пароля
- Подтверждение регистрации через email (опционально)
- После регистрации пользователь перенаправляется на страницу выбора персонажа

### Вход в систему
- Аутентификация с использованием email/пароля
- Генерация и управление JWT-токенами
- Временное ограничение попыток входа при неудачных попытках
- После входа:
  - Если персонаж выбран, перенаправление на карту уровней
  - Если персонаж не выбран, перенаправление на страницу выбора персонажа

### Выход из системы
- Удаление токенов из локального хранилища
- Уничтожение сессии на сервере
- Перенаправление на страницу входа

### Восстановление пароля
- Запрос на восстановление пароля через email
- Генерация временной ссылки для сброса пароля
- Установка нового пароля с валидацией надежности

## Интерфейс

### Страница регистрации
- Форма регистрации с полями:
  - Email
  - Имя пользователя
  - Пароль
  - Подтверждение пароля
- Индикатор надежности пароля
- Кнопка "Зарегистрироваться"
- Ссылка на страницу входа для существующих аккаунтов

### Страница входа
- Форма входа с полями:
  - Email
  - Пароль
- Опция "Запомнить меня"
- Кнопка "Войти"
- Ссылки:
  - "Забыли пароль?"
  - "Создать аккаунт" (ведет на страницу регистрации)

### Страница восстановления пароля
- Форма запроса восстановления с полем для email
- Кнопка "Отправить инструкции по восстановлению"
- Форма установки нового пароля (после перехода по временной ссылке)

## Технические требования

### API Endpoints

#### POST /api/auth/register
- Регистрация нового пользователя
- Принимает: `username`, `email`, `password`
- Возвращает: JWT-токен, информацию о пользователе, статус `hasCharacter: false`

#### POST /api/auth/login
- Аутентификация пользователя
- Принимает: `email`, `password`
- Возвращает: JWT-токен, информацию о пользователе, статус `hasCharacter`

#### POST /api/auth/logout
- Выход из системы
- Требует JWT-аутентификацию
- Уничтожает сессию на сервере

#### POST /api/auth/forgot-password
- Запрос на восстановление пароля
- Принимает: `email`
- Отправляет email с временной ссылкой для сброса пароля

#### POST /api/auth/reset-password
- Установка нового пароля
- Принимает: `token`, `newPassword`
- Требует валидный токен из email

#### GET /api/auth/verify-token
- Проверка валидности JWT-токена
- Требует JWT-аутентификацию
- Возвращает статус валидности и информацию о пользователе

### База данных (MongoDB)
- Коллекция `users`:
  ```json
  {
    "_id": "ObjectId",
    "username": "String",
    "email": "String",
    "password": "String (hashed)",
    "resetPasswordToken": "String (optional)",
    "resetPasswordExpires": "Date (optional)",
    "selectedCharacter": {
      "type": "String",
      "lastSelected": "Date"
    },
    "createdAt": "Date",
    "updatedAt": "Date"
  }
  ```

### Безопасность
1. Хеширование паролей с использованием bcrypt
2. Защита от CSRF и XSS атак
3. Защита от брутфорс атак (ограничение попыток входа)
4. Проверки валидности JWT-токенов
5. HTTPS для всех запросов
6. Валидация данных на стороне клиента и сервера

## Интеграция с другими системами

### Интеграция с системой профиля
- Автоматическое создание профиля пользователя при регистрации
- Доступ к профилю после успешной аутентификации

### Интеграция с системой персонажей
- После регистрации или входа проверка наличия выбранного персонажа
- Маршрутизация в зависимости от статуса выбора персонажа
- Автоматическая сессия, сохраняющая выбранный персонаж между сеансами

### Интеграция с системой уровней
- Проверка авторизации при доступе к уровням
- Защита API запросов, связанных с прогрессом в уровнях

## Маршрутизация и проверки
- Страница входа: `/login`
- Страница регистрации: `/register`
- Страница восстановления пароля: `/forgot-password`
- Страница установки нового пароля: `/reset-password/:token`
- Редирект на выбор персонажа или карту уровней после авторизации
- Защита маршрутов, требующих авторизации
- Перенаправление на вход при отсутствии авторизации

## Критерии готовности
1. Пользователь может успешно зарегистрироваться, войти и выйти из системы
2. Токены JWT корректно генерируются, хранятся и проверяются
3. Система восстановления пароля функционирует корректно
4. Защитные механизмы активированы и работают
5. Перенаправления работают в соответствии со статусом пользователя и наличием персонажа
6. Формы имеют корректную валидацию и обратную связь
7. Система корректно обрабатывает ошибки и отображает понятные сообщения 